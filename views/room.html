<div id="cargando" class="noimagen">
    <br><br><br><br>
    <img src="https://imgur.com/Z9lyXBY.gif" alt="loading...">
</div>
<div id="ver-perfil" class="hidden">
    <div>
        <br>
        <a href="" id="miniperfil-foto-enlace" target="_blank"><img src="https://imgur.com/Wega2Bu.png" alt="x" id="miniperfil-foto"></a>
        <h2 id="miniperfil-nombre">nombre</h2>
        <div id="miniperfil-descripcion">
            asfdasdfaswdf
        </div>
        <br>
        <input type="button" value="Close" id="miniperfil-cerrar" class="boton-normal">
    </div>
</div>
<div id="info-sala">
    <a id="s-enlace-imagen" target="_blank" href="https://imgur.com/Wega2Bu.png"><img id="s-foto-sala" src="https://imgur.com/Wega2Bu.png" alt="X"></a>
    <div>
        <h2 id="s-nombre-sala">X</h2>
        <a href="" id="s-fundador-sala" data-usrid="">By X</a>
        <p id="s-sala-miembros">publica / 888 miembros</p>
    </div>
    <br>
    <div id="s-descripcion-sala">
        X
    </div>
</div>
<br><br><br><br><br><br><br><br>
<div id="caja-id-sala">
    <p id="id-sala" class="hidden">id: sadfasdfasdfasdf</p>
    <input id="check-ver-id" type="checkbox"><p>Visible invitation ID</p>
</div>
<div id="opciones-sala">
    <br>
    <input type="button" id="salir-sala" value="Exit room">
    <input type="button" id="editar-sala" value="Edit room details">
</div>

<div id="cosas-sala">
    <div id="chat">

        

    </div>
    <div id="miembros">
        <h2>Members</h2><hr>

        

    </div>
</div>
<div id="inputs-sala">
    <input type="text" id="escribir-mensaje" placeholder="Send something">
    <button id="mandar-mensaje"><img src="https://imgur.com/0o9W5Xu.png" alt="Send"></button>
    <button id="mandar-archivo"><img src="https://imgur.com/b8vGsmf.png" alt="Send"></button>
</div>

<template id="template-mensaje">
    <div class="mensaje">
        <div class="mensaje-persona" id="mensaje-persona">
            <img class="imagen-mensaje" id="imagen-mensaje" src="" alt="X">
            <a href="#" id="usuario-mensaje" data-usrid="">X</a>
        </div>
        <div class="mensaje-texto" id="mensaje-texto">
            <p id="texto-mensaje">X</p>
        </div>
        <div id="descarga-archivo" class="descarga-archivo">
            <a id="link-descarga" href="#">X</a>
        </div>
        <br>
    </div>
</template>
<template id="template-miembro">
    <div class="un-miembro">
        <div class="miembro-persona" id="miembro-persona">
            <img class="imagen-miembro" id="imagen-miembro" src="" alt="X">
            <a href="#" id="usuario-miembro" data-usrid="">X</a>
        </div>
        
    </div>
</template>

<script>
    document.getElementById("btn-rooms").classList.add("barra-item-activado");
    document.getElementById("logo-arriba").remove();

    if(localStorage.getItem("user") != undefined && localStorage.getItem("user") != "no" && localStorage.getItem("room") != undefined && localStorage.getItem("room") != "no"){
        document.addEventListener("DOMContentLoaded", async () => {
            const miniperfil = async (e, id) => {//abrir miniperfil
                document.getElementById("ver-perfil").classList.remove("hidden");
                document.getElementById("ver-perfil").classList.add("animacion-abrir-miniperfil");
                document.getElementById("ver-perfil").classList.remove("animacion-cerrar-miniperfil");
                let req = await fetch("/b/userProfile/" + id);
                let res = await req.json();
                document.getElementById("miniperfil-foto").src = res.urlFoto;
                document.getElementById("miniperfil-foto-enlace").href = res.urlFoto;
                document.getElementById("miniperfil-nombre").innerHTML = res.nombre;
                document.getElementById("miniperfil-descripcion").innerHTML = res.descripcion;
            }
            document.getElementById("miniperfil-cerrar").addEventListener("click", () => {
                let timerCerrar = setTimeout(() => {
                    document.getElementById("ver-perfil").classList.add("hidden");
                }, 500);
                document.getElementById("ver-perfil").classList.remove("animacion-abrir-miniperfil");
                document.getElementById("ver-perfil").classList.add("animacion-cerrar-miniperfil");
            });



            const salaActual = localStorage.getItem("room");

            let req = await fetch("/b/roomData/" + salaActual);
            let res = await req.json();

            const $nombreSala = document.getElementById("s-nombre-sala");
            $nombreSala.innerHTML = res.nombre;
            //$nombreSala.href = "/seeUser/" + res.idFundador;
            document.querySelector("title").innerHTML = res.nombre + " - Anarchat";
            const $descripiconSala = document.getElementById("s-descripcion-sala");
            $descripiconSala.innerHTML = res.descripcion;
            if(res.descripcion == ""){
                $descripiconSala.remove();
            }
            const $fundadorSala = document.getElementById("s-fundador-sala");
            $fundadorSala.innerHTML = "By: <b>" + res.nombreFundador + "</b>";
            $fundadorSala.setAttribute("data-usrid", res.idFundador);
            const $enlaceImagenSala = document.getElementById("s-enlace-imagen");
            $enlaceImagenSala.href = res.urlFoto;
            const $imagenSala = document.getElementById("s-foto-sala");
            $imagenSala.src = res.urlFoto;
            const $idSala = document.getElementById("id-sala");
            $idSala.innerHTML = "ID: <b>" + res._id + "</b>";
            const $checkId = document.getElementById("check-ver-id");
            const $contadorMiembrosSala = document.getElementById("s-sala-miembros");
            const $botonSalir = document.getElementById("salir-sala");
            $botonSalir.addEventListener("click", (e) => {//salir de la sala
                location.href = "/roomExit"
            });
            const $zonaMiembros = document.getElementById("miembros");
            let reqMiembros = await fetch("/b/roomMembers/" + salaActual);
            let resMiembros = await reqMiembros.json();
            if(res.publica == "true"){
                $contadorMiembrosSala.innerHTML = "Public room";
                document.getElementById("caja-id-sala").remove();
                $botonSalir.remove();
                $zonaMiembros.remove();
            } else {
                $contadorMiembrosSala.innerHTML = "Members: " + resMiembros.idMiembros.length;
                if(res.verID == "false" && localStorage.getItem("user") != res.idFundador){
                    document.getElementById("caja-id-sala").remove();
                }
            }
            let reqFounder = await fetch("/b/founder/" + salaActual);
            let resFounder = await reqFounder.json();
            const $botonEditar = document.getElementById("editar-sala");
            $botonEditar.addEventListener("click", (e) => {//ir a editar la sala
                location.href = "/roomEdit";
            });
            if(resFounder._id != localStorage.getItem("user")){
                $botonEditar.remove();
            } else {
                $botonSalir.remove();
            }
            

            //poner miembros (se deberia hacer con fragmento):
            if(res.publica != "true"){
                //let fragmentoMiembros = document.createDocumentFragment();
                resMiembros.idMiembros.forEach(async (re) => {
                    const $cuadros = document.createElement("div");
                    $cuadros.innerHTML = document.getElementById("template-miembro").innerHTML;
                    let reqPerf = await fetch("/b/userProfile/" + re);
                    let resPerf = await reqPerf.json();
                    if(re == resFounder._id){
                        $cuadros.querySelector("#usuario-miembro").innerHTML = '<b id="nombre-miembro-fundador">' + resPerf.nombre + '</b>';
                    } else {
                        $cuadros.querySelector("#usuario-miembro").innerHTML = resPerf.nombre;
                    }
                    $cuadros.querySelector("#usuario-miembro").setAttribute("data-usrid", re);
                    $cuadros.querySelector("#imagen-miembro").src = resPerf.urlFoto;
                    document.getElementById("miembros").innerHTML += $cuadros.innerHTML;
                });
            //document.getElementById("miembros").innerHTML += fragmentoMiembros.innerHTML;
            }
            //poner mensajes:





            const $cajaTexto = document.getElementById("escribir-mensaje");
            const mandarTexto = async (elTexto) => {//enviar un mensaje
                console.log(elTexto);
            }
            const mandarArchivo = async () => {//enviar un archivo
                
            }
            document.getElementById("mandar-mensaje").addEventListener("click", (e) => {
                if($cajaTexto.value != ""){
                    mandarTexto($cajaTexto.value);
                    $cajaTexto.value = "";
                }
            });
            document.addEventListener("keydown", (e) => {
                if(e.code == "Enter" && $cajaTexto.value != ""){
                    mandarTexto($cajaTexto.value);
                    $cajaTexto.value = "";
                }
            });
            document.getElementById("mandar-archivo").addEventListener("click", (e) => {
                mandarArchivo();
            });



            document.getElementById("cargando").classList.add("hidden");
            $checkId.addEventListener("change", (e) => {//ver id
                if($checkId.checked){
                    $idSala.classList.remove("hidden");
                } else {
                    $idSala.classList.add("hidden");
                }
            });
            $fundadorSala.addEventListener("click", (e) => {//mostrar perfil del fundador
                e.preventDefault();
            });

            let cont = setTimeout(() => {
                document.querySelectorAll('[data-usrid]').forEach((el) => {
                    el.addEventListener("click", function(e) {
                        e.preventDefault();
                        const elId = this.getAttribute("data-usrid");
                        miniperfil(e, elId);
                    })
                });
            }, 100);
        });
    } else {
        window.location.href == "/err404"
    }
    
</script>